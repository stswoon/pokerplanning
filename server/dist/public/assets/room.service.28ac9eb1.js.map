{"version":3,"file":"room.service.28ac9eb1.js","sources":["../../src/utils.ts","../../src/modules/room/room.service.ts"],"sourcesContent":["function redirect(relativeUrl: string): void {\r\n    console.log(\"redirect\")\r\n    window.location.href = relativeUrl;\r\n}\r\n\r\nfunction getQueryParameter(name: string): string | null {\r\n    const params = new URLSearchParams(window.location.search);\r\n    return params.get(name);\r\n}\r\n\r\nconst utils = {\r\n    redirect,\r\n    getQueryParameter\r\n}\r\n\r\nexport default utils;\r\n\r\nexport type JsMap<K extends string, V> = { [key in K]: V; };\r\n","import utils from \"@/utils\";\r\nimport type {Room} from \"@/modules/room/room.model\";\r\n\r\nlet ws: WebSocket;\r\n\r\nconst setUserId = (userId: string): void => localStorage.setItem(\"userId\", userId);\r\nconst getUserId = (): string | null => localStorage.getItem(\"userId\");\r\nconst setUserName = (userName: string): void => localStorage.setItem(\"userName\", userName);\r\nconst getUserName = (): string | null => localStorage.getItem(\"userName\");\r\n\r\nfunction attachWsToRoom(callback: (data: Room) => void) {\r\n    let wsTry = 0;\r\n    const MAX_TRIES = 5;\r\n    const CONNECTION_TIMEOUT = 30 * 1000;\r\n\r\n    const roomId = utils.getQueryParameter('roomId');\r\n    const userId = getUserId();\r\n    const userName = getUserName();\r\n    const wsProtocol = window.location.protocol === \"https:\" ? \"wss\" : \"ws\";\r\n    ws = new WebSocket(`${wsProtocol}://${window.location.host}/api/roomState?roomId=${roomId}&userId=${userId}&userName=${userName}`);\r\n\r\n    const wsConnectionTimeoutId = setTimeout(() => {\r\n        console.error(\"Failed to connect WS after 30 sec\");\r\n        ws.close(5000, \"Client 30 sec timeout\");\r\n    }, CONNECTION_TIMEOUT);\r\n\r\n    let wsHeartbeatTimeoutId;\r\n\r\n    ws.onopen = () => {\r\n        console.info(\"WS connected\");\r\n        wsTry = 0;\r\n        wsHeartbeatTimeoutId = clearTimeout(wsConnectionTimeoutId);\r\n\r\n        setTimeout(() => {\r\n            console.log(\"ping\");\r\n            ws.send(\"H\")\r\n        }, 50 * 1000);\r\n    };\r\n\r\n    ws.onclose = (event: CloseEvent) => {\r\n        clearTimeout(wsConnectionTimeoutId);\r\n        if (event.wasClean) {\r\n            console.error('WS closed normally');\r\n        } else {\r\n            console.error('WS interrupted');\r\n            if (wsTry < MAX_TRIES) {\r\n                console.log('Try connect again');\r\n                setTimeout(() => attachWsToRoom(callback), ++wsTry * 1000);\r\n            } else {\r\n                console.error(\"SYSTEM ERROR: Can't connect to server, achieved max count of attempts\");\r\n                alert(\"SYSTEM ERROR: Can't connect to server\");\r\n            }\r\n        }\r\n        clearTimeout(wsHeartbeatTimeoutId);\r\n        console.debug(`WS error code ${event.code} and reason ${event.reason}`);\r\n    };\r\n\r\n    ws.onerror = (error: any) => {\r\n        clearTimeout(wsHeartbeatTimeoutId);\r\n        console.error(\"WS error:\" + error.message);\r\n    }\r\n\r\n    ws.onmessage = (event: MessageEvent) => {\r\n        console.debug(\"WS data\", event.data);\r\n        if (event.data === \"H\") {\r\n            console.debug(\"heart-bit\");\r\n        } else {\r\n            callback(JSON.parse(event.data));\r\n        }\r\n    };\r\n}\r\n\r\nconst flipCards = () => ws.send(\"flipCards\");\r\n\r\nconst clearCards = () => ws.send(\"clearCards\");\r\n\r\nfunction throwCard(cardValue: number | string) {\r\n    const userId = getUserId();\r\n    ws.send(JSON.stringify({vote: {userId, cardValue}}));\r\n}\r\n\r\nexport const roomService = {\r\n    attachWsToRoom,\r\n    throwCard,\r\n    flipCards,\r\n    clearCards,\r\n    setUserId,\r\n    getUserId,\r\n    setUserName,\r\n    getUserName,\r\n}\r\n"],"names":["redirect","relativeUrl","getQueryParameter","name","utils","ws","setUserId","userId","getUserId","setUserName","userName","getUserName","attachWsToRoom","callback","wsTry","MAX_TRIES","CONNECTION_TIMEOUT","roomId","wsProtocol","wsConnectionTimeoutId","wsHeartbeatTimeoutId","event","error","flipCards","clearCards","throwCard","cardValue","roomService"],"mappings":"AAAA,SAASA,EAASC,EAA2B,CACzC,QAAQ,IAAI,UAAU,EACtB,OAAO,SAAS,KAAOA,CAC3B,CAEA,SAASC,EAAkBC,EAA6B,CAE7C,OADQ,IAAI,gBAAgB,OAAO,SAAS,MAAM,EAC3C,IAAIA,CAAI,CAC1B,CAEA,MAAMC,EAAQ,CACV,SAAAJ,EACA,kBAAAE,CACJ,ECVA,IAAIG,EAEJ,MAAMC,EAAaC,GAAyB,aAAa,QAAQ,SAAUA,CAAM,EAC3EC,EAAY,IAAqB,aAAa,QAAQ,QAAQ,EAC9DC,EAAeC,GAA2B,aAAa,QAAQ,WAAYA,CAAQ,EACnFC,EAAc,IAAqB,aAAa,QAAQ,UAAU,EAExE,SAASC,EAAeC,EAAgC,CACpD,IAAIC,EAAQ,EACZ,MAAMC,EAAY,EACZC,EAAqB,GAAK,IAE1BC,EAASb,EAAM,kBAAkB,QAAQ,EACzCG,EAASC,IACTE,EAAWC,IACXO,EAAa,OAAO,SAAS,WAAa,SAAW,MAAQ,KAC9Db,EAAA,IAAI,UAAU,GAAGa,OAAgB,OAAO,SAAS,6BAA6BD,YAAiBV,cAAmBG,GAAU,EAE3H,MAAAS,EAAwB,WAAW,IAAM,CAC3C,QAAQ,MAAM,mCAAmC,EAC9Cd,EAAA,MAAM,IAAM,uBAAuB,GACvCW,CAAkB,EAEjB,IAAAI,EAEJf,EAAG,OAAS,IAAM,CACd,QAAQ,KAAK,cAAc,EACnBS,EAAA,EACRM,EAAuB,aAAaD,CAAqB,EAEzD,WAAW,IAAM,CACb,QAAQ,IAAI,MAAM,EAClBd,EAAG,KAAK,GAAG,CAAA,EACZ,GAAK,GAAI,CAAA,EAGbA,EAAA,QAAWgB,GAAsB,CAChC,aAAaF,CAAqB,EAC9BE,EAAM,SACN,QAAQ,MAAM,oBAAoB,GAElC,QAAQ,MAAM,gBAAgB,EAC1BP,EAAQC,GACR,QAAQ,IAAI,mBAAmB,EAC/B,WAAW,IAAMH,EAAeC,CAAQ,EAAG,EAAEC,EAAQ,GAAI,IAEzD,QAAQ,MAAM,uEAAuE,EACrF,MAAM,uCAAuC,IAGrD,aAAaM,CAAoB,EACjC,QAAQ,MAAM,iBAAiBC,EAAM,mBAAmBA,EAAM,QAAQ,CAAA,EAGvEhB,EAAA,QAAWiB,GAAe,CACzB,aAAaF,CAAoB,EACzB,QAAA,MAAM,YAAcE,EAAM,OAAO,CAAA,EAG1CjB,EAAA,UAAagB,GAAwB,CAC5B,QAAA,MAAM,UAAWA,EAAM,IAAI,EAC/BA,EAAM,OAAS,IACf,QAAQ,MAAM,WAAW,EAEzBR,EAAS,KAAK,MAAMQ,EAAM,IAAI,CAAC,CACnC,CAER,CAEA,MAAME,EAAY,IAAMlB,EAAG,KAAK,WAAW,EAErCmB,EAAa,IAAMnB,EAAG,KAAK,YAAY,EAE7C,SAASoB,EAAUC,EAA4B,CAC3C,MAAMnB,EAASC,IACZH,EAAA,KAAK,KAAK,UAAU,CAAC,KAAM,CAAC,OAAAE,EAAQ,UAAAmB,EAAW,CAAA,CAAC,CACvD,CAEO,MAAMC,EAAc,CACvB,eAAAf,EACA,UAAAa,EACA,UAAAF,EACA,WAAAC,EACA,UAAAlB,EACA,UAAAE,EACA,YAAAC,EACA,YAAAE,CACJ"}